<!DOCTYPE html>
<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
        <title>Watcher üëÅÔ∏è</title>

        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üëÅÔ∏è</text></svg>">

        <script type="text/javascript" src="dist/watcher.js"></script>

        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div id="main">
            <div id="controlspanel">
                <h1>
                    Set a connection string
                </h1>
        
                <label for="connection">SAS Connection String: </label>
                <input  autocomplete="on" type="text" id="connection"/>
        
                <h1>
                    Queue a work item
                </h1>
                <form id="submissioncontrol">
                    <ul>
                        <li>
                            <label for="url">URL: </label>
                            <input type="text" id="url"/>
                        <li>
                            <label for="payloadtype">Targeted Resource: </label>
                            <select name="payload_type" id="payloadtype">
                                <option value="youtubedl">YoutubeDL</option>
                            </select>
                        </li>
                        <li>
                            <label for="qualityselection">Audio or Video: </label>
    
                            <select name="quality_selection" id="qualityselection">
                                <option value="bestaudio+bestvideo">Audio + Video</option>
                                <option value="bestaudio">Audio Only</option>
                            </select>
                        </li>
                        <li>
                            <button id="enqueue" class="button" type="button">Queue</button><button id="requeue" class="button" type="button">Requeue Last Successful</button>
                        </li>
                    </ul>
                </form>
            </div>
            <div id="sidepanel">
            </div>
            <div id="outputpanel">
                <h2>
                    Dequeue a workitem    
                </h2>
                <button id="dequeue">Dequeue Work</button>
                
                <h3>
                    View Result Output
                </h3>
                <textarea id="viewport">Output will be displayed here.</textarea>
            </div>
        </div>
    </body>

    <script type="text/javascript">
        let tOut = watcher.StartQueueWatcher(document.getElementById("sidepanel"), "connection")

        var lastRequest = {};
        document.getElementById("enqueue").addEventListener("click", async function(event){
            try {
                let watcherClient = new watcher.WatcherClient(document.getElementById("connection").value, "watcher");
                
                let payloadType = document.getElementById("payloadtype").value;
                let qualitySelection = document.getElementById("qualityselection").value;
                let url = document.getElementById("url").value;

                let payload = new watcher.WatcherPayload(payloadType, qualitySelection, url);

                watcher.SetOutputWindowStatus("loading", "Adding Queue Item...");
                let result = await watcherClient.enqueue(payload);
                document.getElementById("url").value = '';
                lastRequest = payload;
                watcher.SetOutputWindowStatus("success", JSON.stringify(result, undefined, 4));
            }
            catch(err) {
                watcher.SetOutputWindowStatus("failure", JSON.stringify(err, undefined, 4));
            }
        });

        document.getElementById("dequeue").addEventListener("click", async function(event){
            try {
                let watcherClient = new watcher.WatcherClient(document.getElementById("connection").value, "watcher");
                watcher.SetOutputWindowStatus("loading", "Retrieving Item From Queue...");
                let result = await watcherClient.dequeue();
                watcher.SetOutputWindowStatus("success", JSON.stringify(result, undefined, 4));
            }
            catch(err){
                watcher.SetOutputWindowStatus("failure", JSON.stringify(err, undefined, 4));
            }
        });

        document.getElementById("requeue").addEventListener("click", async function(event){
            try {
                let watcherClient = new watcher.WatcherClient(document.getElementById("connection").value, "watcher");
                watcher.SetOutputWindowStatus("loading", "Adding Queue Item...");
                let result = await watcherClient.enqueue(lastRequest);
                document.getElementById("url").value = '';
                watcher.SetOutputWindowStatus("success", JSON.stringify(result, undefined, 4));
            }
            catch(err) {
                watcher.SetOutputWindowStatus("failure", JSON.stringify(err, undefined, 4));
            }
        });
    </script>
</html>